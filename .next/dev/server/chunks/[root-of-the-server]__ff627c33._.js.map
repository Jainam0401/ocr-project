{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ASUS/Desktop/ocr-project/app/api/extract-text/route.ts"],"sourcesContent":["// app/api/extract-text/route.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport fs from \"fs/promises\";\r\nimport path from \"path\";\r\nimport Tesseract from 'tesseract.js';\r\n\r\nimport { fromPath } from \"pdf2pic\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\n\r\nexport const maxDuration = 300; // 5 minutes max\r\nexport const dynamic = \"force-dynamic\";\r\n\r\ninterface OCRProgress {\r\n  currentPage: number;\r\n  totalPages: number;\r\n  status: string;\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  let tempDir: string | null = null;\r\n  let pdfPath: string | null = null;\r\n\r\n  try {\r\n    const formData = await req.formData();\r\n    const file = formData.get(\"file\") as File;\r\n    const language = (formData.get(\"language\") as string) || \"eng\"; // Support multi-language\r\n\r\n    if (!file) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"No file uploaded\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!file.name.toLowerCase().endsWith(\".pdf\")) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Only PDF files are supported\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Create unique temp directory\r\n    const uniqueId = uuidv4();\r\n    tempDir = path.join(process.cwd(), \"temp\", uniqueId);\r\n    await fs.mkdir(tempDir, { recursive: true });\r\n\r\n    // Save PDF file\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    pdfPath = path.join(tempDir, `${uniqueId}.pdf`);\r\n    await fs.writeFile(pdfPath, buffer);\r\n\r\n    console.log(`üìÑ Processing PDF: ${file.name} (${(buffer.length / 1024).toFixed(2)} KB)`);\r\n\r\n    // Convert PDF to images using pdf2pic\r\n    const convert = fromPath(pdfPath, {\r\n      density: 300, // Higher quality\r\n      saveFilename: \"page\",\r\n      savePath: tempDir,\r\n      format: \"png\",\r\n      width: 2480,\r\n      height: 3508,\r\n    });\r\n\r\n    // Get page count\r\n    const pdfLib = await import(\"pdf-lib\");\r\n    const pdfDoc = await pdfLib.PDFDocument.load(buffer);\r\n    const totalPages = pdfDoc.getPageCount();\r\n\r\n    console.log(`üìä Total pages: ${totalPages}`);\r\n\r\n    // Create Tesseract worker with language support\r\n    const worker = await Tesseract.createWorker(language, 1, {\r\n      logger: (m) => {\r\n        if (m.status === \"recognizing text\") {\r\n          console.log(`üîç OCR Progress: ${(m.progress * 100).toFixed(1)}%`);\r\n        }\r\n      },\r\n    });\r\n\r\n    let extractedText = \"\";\r\n    const progress: OCRProgress[] = [];\r\n\r\n    // Process each page\r\n    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {\r\n      try {\r\n        console.log(`\\nüìÑ Processing page ${pageNum}/${totalPages}...`);\r\n\r\n        // Convert page to image\r\n        await convert(pageNum, { responseType: \"image\" });\r\n\r\n        // Find the generated image\r\n        const files = await fs.readdir(tempDir);\r\n        const imageName = files.find(\r\n          (f) => f.includes(`page.${pageNum}`) && f.endsWith(\".png\")\r\n        );\r\n\r\n        if (!imageName) {\r\n          console.error(`‚ùå Image not found for page ${pageNum}`);\r\n          extractedText += `\\n\\n--- Page ${pageNum} ---\\n[Error: Could not convert page to image]\\n`;\r\n          continue;\r\n        }\r\n\r\n        const imagePath = path.join(tempDir, imageName);\r\n\r\n        // Perform OCR\r\n        const {\r\n          data: { text, confidence },\r\n        } = await worker.recognize(imagePath);\r\n\r\n        extractedText += `\\n\\n--- Page ${pageNum} ---\\n${text}`;\r\n\r\n        progress.push({\r\n          currentPage: pageNum,\r\n          totalPages,\r\n          status: `Completed page ${pageNum} with ${confidence.toFixed(1)}% confidence`,\r\n        });\r\n\r\n        console.log(`‚úÖ Page ${pageNum} completed (Confidence: ${confidence.toFixed(1)}%)`);\r\n      } catch (pageError: any) {\r\n        console.error(`‚ùå Error processing page ${pageNum}:`, pageError.message);\r\n        extractedText += `\\n\\n--- Page ${pageNum} ---\\n[Error: ${pageError.message}]\\n`;\r\n      }\r\n    }\r\n\r\n    await worker.terminate();\r\n\r\n    console.log(`\\n‚ú® Extraction complete! Total text length: ${extractedText.length} characters`);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      text: extractedText.trim(),\r\n      metadata: {\r\n        fileName: file.name,\r\n        fileSize: `${(buffer.length / 1024).toFixed(2)} KB`,\r\n        totalPages,\r\n        language,\r\n        processingTime: `${Date.now()} ms`,\r\n      },\r\n      progress,\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"‚ùå PDF processing error:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: error.message || \"Failed to process PDF\",\r\n        details: error.stack,\r\n      },\r\n      { status: 500 }\r\n    );\r\n  } finally {\r\n    // Cleanup temp directory\r\n    if (tempDir) {\r\n      try {\r\n        await fs.rm(tempDir, { recursive: true, force: true });\r\n        console.log(\"üßπ Cleaned up temporary files\");\r\n      } catch (cleanupError: any) {\r\n        console.error(\"‚ö†Ô∏è Cleanup error:\", cleanupError.message);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Health check endpoint\r\nexport async function GET() {\r\n  return NextResponse.json({\r\n    status: \"healthy\",\r\n    endpoint: \"/api/extract-text\",\r\n    methods: [\"POST\"],\r\n    description: \"OCR API for PDF text extraction\",\r\n  });\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}